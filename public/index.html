<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat App</title>
  <style>
    body {
      background-color: #202225;
      color: white;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }

    #chatScreen {
      display: none;
      width: 90%;
      max-width: 600px;
      height: 70%;
      background-color: #2f3136;
      border-radius: 10px;
      padding: 20px;
      flex-direction: column;
      display: flex;
      justify-content: flex-end;
    }

    #chatBox {
      flex-grow: 1;
      overflow-y: auto;
      margin-bottom: 20px;
      padding: 10px;
      background-color: #36393f;
      border-radius: 8px;
      box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.1);
    }

    input {
      padding: 10px;
      border: 1px solid #444;
      border-radius: 4px;
      background-color: #40444b;
      color: white;
      width: 100%;
    }

    button {
      background-color: #4CAF50;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      width: 80%;
    }

    #welcomeScreen {
      text-align: center;
      margin-bottom: 20px;
    }

    #errorMessage {
      color: red;
      margin-top: 10px;
      display: none;
    }

    .message {
      padding: 10px;
      margin: 5px 0;
      border-radius: 5px;
      max-width: 75%;
      word-wrap: break-word;
      opacity: 0;
      animation: fadeIn 1s forwards;
      position: relative;
    }

    .my-message {
      background-color: #4CAF50;
      align-self: flex-start; /* Align to the left */
    }

    .other-message {
      background-color: #7289da;
      align-self: flex-end; /* Align to the right */
    }

    .timestamp {
      font-size: 10px;
      position: absolute;
      bottom: 5px;
      right: 5px;
      opacity: 0.7;
    }

    @keyframes fadeIn {
      0% { opacity: 0; }
      100% { opacity: 1; }
    }
  </style>
</head>
<body>

<!-- Welcome Screen for Name Input -->
<div id="welcomeScreen">
  <input id="nameInput" type="text" placeholder="Enter your name" />
  <button id="enterButton">Enter</button>
  <div id="errorMessage"></div>
</div>

<!-- Chat Screen -->
<div id="chatScreen">
  <div id="chatBox">
    <!-- Messages will appear here -->
  </div>
  <input id="messageInput" type="text" placeholder="Type your message..." />
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();
  let userName = '';

  // Check if there's a stored username in localStorage
  const storedName = localStorage.getItem('userName');
  if (storedName) {
    // If a username exists, skip the welcome screen and go to chat screen
    userName = storedName;
    document.getElementById('welcomeScreen').style.display = 'none';
    document.getElementById('chatScreen').style.display = 'flex';
  }

  // Handle Enter Button Click
  document.getElementById('enterButton').addEventListener('click', async () => {
    const enteredName = document.getElementById('nameInput').value.trim();
    if (enteredName) {
      try {
        const response = await fetch('/set-name', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userName: enteredName })
        });

        const data = await response.json();
        if (data.success) {
          // Store the username in localStorage
          userName = enteredName;
          localStorage.setItem('userName', userName);  // Save the name for future sessions

          document.getElementById('welcomeScreen').style.display = 'none';
          document.getElementById('chatScreen').style.display = 'flex';

          // Emit the username to the server to join the chat
          socket.emit('sendMessage', { sender: userName, message: `${userName} has joined the chat!` });
        } else {
          document.getElementById('errorMessage').style.display = 'block';
        }
      } catch (err) {
        console.error(err);
        document.getElementById('errorMessage').style.display = 'block';
      }
    }
  });

  // Function to format time in 12-hour format (AM/PM)
  function formatTime() {
    const now = new Date();
    let hours = now.getHours();
    let minutes = now.getMinutes();
    const ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12;
    hours = hours ? hours : 12; // 12 hour format
    minutes = minutes < 10 ? '0' + minutes : minutes;
    return `${hours}:${minutes} ${ampm}`;
  }

  // Handle Message Sending
  document.getElementById('messageInput').addEventListener('keydown', (event) => {
    if (event.key === 'Enter') {
      const messageContent = document.getElementById('messageInput').value.trim();
      if (messageContent) {
        // Emit the message to the server with timestamp
        socket.emit('sendMessage', { sender: userName, message: messageContent, time: formatTime() });
        document.getElementById('messageInput').value = '';
      }
    }
  });

  // Function to display messages with timestamp
  function displayMessage(sender, message, time) {
    const chatBox = document.getElementById('chatBox');
    const messageDiv = document.createElement('div');
    messageDiv.textContent = `${sender}: ${message}`;

    const timestamp = document.createElement('span');
    timestamp.classList.add('timestamp');
    timestamp.textContent = time;

    messageDiv.appendChild(timestamp);
    messageDiv.classList.add('message');
    messageDiv.classList.add(sender === userName ? 'my-message' : 'other-message');
    chatBox.appendChild(messageDiv);
    chatBox.scrollTop = chatBox.scrollHeight; // Auto-scroll to the bottom
  }

  // Function to send notification
  function sendNotification(message) {
    if (Notification.permission === 'granted') {
      new Notification('New Message', {
        body: message,
        icon: 'path_to_icon.png', // Optional: Set your icon here
      });
    }
  }

  // Request Notification Permission if not granted
  if (Notification.permission !== 'granted') {
    Notification.requestPermission().then(permission => {
      if (permission === 'granted') {
        console.log('Notification permission granted');
      }
    });
  }

  // Listen for new messages from the server
  socket.on('newMessage', (messageData) => {
    displayMessage(messageData.sender, messageData.message, messageData.time);

    // Send a notification for messages from other users
    if (messageData.sender !== userName) {
      sendNotification(`${messageData.sender}: ${messageData.message}`);
    }
  });

  // Listen for previous messages on reconnect
  socket.on('previousMessages', (messages) => {
    messages.forEach(msg => {
      displayMessage(msg.sender, msg.message, msg.time);
    });
  });
</script>

</body>
</html>
